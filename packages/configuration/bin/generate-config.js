/**
 * This script extracts version and metadata from the root package.json and pbiviz.json
 * and generates a TypeScript file with these values. This avoids runtime JSON imports
 * that break when the package is consumed from node_modules.
 */
import { readFileSync, writeFileSync, mkdirSync } from 'fs';
import { dirname, resolve } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = resolve(__dirname, '../../..');

// Read source files
const packageJson = JSON.parse(
    readFileSync(resolve(rootDir, 'package.json'), 'utf-8')
);
const pbivizJson = JSON.parse(
    readFileSync(resolve(rootDir, 'pbiviz.json'), 'utf-8')
);

// Extract only what we need
const config = {
    devDependencies: {
        vega: packageJson.devDependencies['vega'],
        'vega-lite': packageJson.devDependencies['vega-lite']
    },
    visual: pbivizJson.visual
};

// Generate TypeScript file
const output = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT
 * Generated by bin/generate-config.js
 * 
 * Contains version and metadata extracted from root package.json and pbiviz.json
 */

export const devDependencies = ${JSON.stringify(config.devDependencies, null, 4)} as const;

export const visual = ${JSON.stringify(config.visual, null, 4)} as const;
`;

// Ensure src directory exists and write file
const outputPath = resolve(__dirname, '../src/generated.ts');
mkdirSync(dirname(outputPath), { recursive: true });
writeFileSync(outputPath, output, 'utf-8');

console.log('Generated src/generated.ts');
